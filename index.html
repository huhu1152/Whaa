<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التعرف على أنواع الأحجار الكريمة</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* جميع التنسيقات CSS السابقة تبقى كما هي (لن أعيد نسخها لتوفير المساحة) */
    </style>
</head>
<body>
    <!-- عناصر واجهة المستخدم تبقى كما هي -->
    <div class="container">
        <header>
            <h1><i class="fas fa-gem"></i> نظام التعرف على الأحجار الكريمة</h1>
            <p class="subtitle">استخدم الذكاء الاصطناعي للتعرف على أنواع الأحجار المختلفة من خلال تحميل صورة للحجر</p>
        </header><div class="model-status" id="modelStatus">
        <i class="fas fa-sync fa-spin"></i> جاري تحميل نموذج الذكاء الاصطناعي...
    </div>

    <!-- بقية واجهة المستخدم تبقى كما هي -->

    <div class="result-card">
        <div id="result">النتيجة ستظهر هنا</div>
        <div class="confidence" id="confidence"></div>
        <div class="error-message" id="errorMessage"></div>
        <button class="retry-btn" id="retryBtn" style="display:none;">
            <i class="fas fa-redo"></i> إعادة المحاولة
        </button>
    </div>
</div>

<script>
    const classNames = [
        "حجر الفمر", "حجر الهبهاب", "حجر الباقوت", "حجر اليشب", "حجر البشم",
        "حجر الفيروز", "در النجف", "عباس اباد", "عقيق", "عقيق - شرف الشمس",
        "الؤلؤ الأبيض", "الؤلؤ الأسود", "الزمرد", "حجر الأزورد", "حجر الأوبال",
        "حجر الجمشت", "حجر الحديد الصيني (الهيمتايت)", "حجر الزفير", "حجر السلطاني", "حجر القمر"
    ];

    let model;
    let uploadedImage;

    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const predictBtn = document.getElementById('predictBtn');
    const resultDiv = document.getElementById('result');
    const confidenceDiv = document.getElementById('confidence');
    const errorMessage = document.getElementById('errorMessage');
    const modelStatus = document.getElementById('modelStatus');
    const retryBtn = document.getElementById('retryBtn');

    async function loadModel() {
        try {
            modelStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> جاري تحميل النموذج...';
            model = await tf.loadGraphModel('./model/model.json');
            modelStatus.innerHTML = '<i class="fas fa-check-circle"></i> النموذج جاهز!';
            predictBtn.disabled = false;
        } catch (error) {
            console.error("خطأ في تحميل النموذج:", error);
            modelStatus.innerHTML = '<i class="fas fa-times-circle"></i> فشل تحميل النموذج';
            errorMessage.textContent = 'تعذر تحميل النموذج. تأكد من وجود ملفات النموذج في المجلد الصحيح.';
            retryBtn.style.display = 'block';
        }
    }

    retryBtn.addEventListener('click', loadModel);

    imageUpload.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const newImage = new Image();
                newImage.onload = function() {
                    imagePreview.src = newImage.src;
                    imagePreview.style.display = 'block';
                    uploadedImage = newImage;
                    predictBtn.disabled = false;
                };
                newImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    async function predictImage() {
        if (!uploadedImage || !model) return;
        try {
            const tensor = tf.browser.fromPixels(uploadedImage)
                .resizeNearestNeighbor([224, 224])
                .toFloat()
                .div(255.0)
                .expandDims();

            const predictions = await model.predict(tensor).data();
            tensor.dispose();

            let max = 0, index = 0;
            for (let i = 0; i < predictions.length; i++) {
                if (predictions[i] > max) {
                    max = predictions[i];
                    index = i;
                }
            }

            resultDiv.textContent = `نوع الحجر: ${classNames[index]}`;
            confidenceDiv.textContent = `مستوى الثقة: ${(max * 100).toFixed(2)}%`;
        } catch (error) {
            console.error('خطأ في التنبؤ:', error);
            errorMessage.textContent = 'فشل في تحليل الصورة. حاول مجددًا.';
        }
    }

    predictBtn.addEventListener('click', predictImage);
    loadModel();
</script>

</body>
</html>
